# .github/workflows/setup.yml
# PURPOSE: First-time setup - creates Flutter project and commits to repo
# RUN: Manually trigger from Actions tab (only run ONCE)

name: ðŸš€ First-Time Setup - Create Flutter Project

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Flutter project name (lowercase, underscores)'
        required: true
        default: 'compliance_app'
      org_name:
        description: 'Organization identifier (com.yourcompany)'
        required: true
        default: 'com.compliancemanagement'

env:
  FLUTTER_VERSION: '3.19.0'
  JAVA_VERSION: '17'

jobs:
  setup:
    name: Create Flutter Project
    runs-on: ubuntu-latest
    
    steps:
      # ========== CHECKOUT EMPTY REPO ==========
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # ========== SETUP JAVA (for Android) ==========
      - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      # ========== SETUP FLUTTER WITH CACHE ==========
      - name: ðŸ¦ Setup Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          cache-key: 'flutter-:os:-:channel:-:version:-:arch:-:hash:'
          cache-path: '${{ runner.tool_cache }}/flutter/:channel:-:version:-:arch:'

      # ========== VERIFY FLUTTER ==========
      - name: âœ… Verify Flutter Installation
        run: |
          flutter --version
          flutter doctor -v

      # ========== CREATE FLUTTER PROJECT ==========
      - name: ðŸ—ï¸ Create Flutter Project
        run: |
          # Create project with all platforms
          flutter create \
            --project-name=${{ github.event.inputs.project_name }} \
            --org=${{ github.event.inputs.org_name }} \
            --platforms=android,ios,web \
            --description="Compliance Management System - Tasks, Calendar, Mail Automation" \
            temp_project
          
          # Move contents to repo root (excluding .git)
          shopt -s dotglob
          mv temp_project/* .
          rm -rf temp_project
          
          echo "âœ… Flutter project created successfully!"

      # ========== ADD DEPENDENCIES TO PUBSPEC.YAML ==========
      - name: ðŸ“¦ Update pubspec.yaml with Dependencies
        run: |
          cat > pubspec.yaml << 'EOF'
          name: ${{ github.event.inputs.project_name }}
          description: Compliance Management System - Tasks, Calendar, Mail Automation
          publish_to: 'none'
          version: 1.0.0+1

          environment:
            sdk: '>=3.2.0 <4.0.0'

          dependencies:
            flutter:
              sdk: flutter
            
            # Firebase
            firebase_core: ^2.25.0
            firebase_auth: ^4.17.0
            cloud_firestore: ^4.15.0
            firebase_messaging: ^14.7.0
            firebase_storage: ^11.6.0
            
            # State Management
            flutter_riverpod: ^2.4.10
            
            # HTTP & API
            dio: ^5.4.1
            
            # UI Components
            flutter_svg: ^2.0.10
            cached_network_image: ^3.3.1
            shimmer: ^3.0.0
            google_fonts: ^6.1.0
            
            # Calendar
            table_calendar: ^3.0.9
            
            # Charts
            fl_chart: ^0.66.2
            
            # File Handling
            file_picker: ^6.1.1
            open_file: ^3.3.2
            path_provider: ^2.1.2
            
            # Local Storage
            shared_preferences: ^2.2.2
            
            # Utils
            intl: ^0.18.1
            url_launcher: ^6.2.4
            package_info_plus: ^5.0.1
            connectivity_plus: ^5.0.2
            
            # Biometric Auth
            local_auth: ^2.1.8
            
            # Icons
            cupertino_icons: ^1.0.6

          dev_dependencies:
            flutter_test:
              sdk: flutter
            flutter_lints: ^3.0.1
            flutter_launcher_icons: ^0.13.1
            build_runner: ^2.4.8

          # App Icon Configuration
          flutter_launcher_icons:
            android: true
            ios: true
            web:
              generate: true
            image_path: "assets/icon/app_icon.png"
            adaptive_icon_background: "#0078D4"
            adaptive_icon_foreground: "assets/icon/app_icon_foreground.png"

          flutter:
            uses-material-design: true
            
            assets:
              - assets/images/
              - assets/icon/

            fonts:
              - family: Inter
                fonts:
                  - asset: assets/fonts/Inter-Regular.ttf
                  - asset: assets/fonts/Inter-Medium.ttf
                    weight: 500
                  - asset: assets/fonts/Inter-SemiBold.ttf
                    weight: 600
                  - asset: assets/fonts/Inter-Bold.ttf
                    weight: 700
                  - asset: assets/fonts/Inter-ExtraBold.ttf
                    weight: 800
                  - asset: assets/fonts/Inter-Black.ttf
                    weight: 900
          EOF

      # ========== CREATE FOLDER STRUCTURE ==========
      - name: ðŸ“ Create Project Structure
        run: |
          # Create directories
          mkdir -p lib/config
          mkdir -p lib/models
          mkdir -p lib/services
          mkdir -p lib/providers
          mkdir -p lib/screens
          mkdir -p lib/widgets
          mkdir -p lib/utils
          mkdir -p assets/images
          mkdir -p assets/icon
          mkdir -p assets/fonts
          
          echo "âœ… Folder structure created!"

      # ========== CREATE PLACEHOLDER FILES ==========
      - name: ðŸ“ Create Placeholder Files
        run: |
          # Config files
          cat > lib/config/api_config.dart << 'EOF'
          // API Configuration
          // TODO: Replace with your Netlify URL
          class ApiConfig {
            static const String baseUrl = 'https://YOUR-SITE.netlify.app/.netlify/functions';
            
            // Endpoints
            static const String tasksCreateOne = '/tasks_createone';
            static const String tasksUpdateStatus = '/tasks_updatestatus';
            static const String tasksUpdateTask = '/tasks_updatetask';
            static const String tasksDelete = '/tasks_delete';
            static const String tasksBulkImport = '/tasks_bulkimportxlsx';
            static const String clientsCreate = '/clients_create';
            static const String usersSetRole = '/users_setrole';
            static const String usersSetManager = '/users_setmanager';
            static const String usersList = '/users_list';
            static const String settingsGet = '/settings_get';
            static const String settingsUpdate = '/settings_update';
            static const String settingsCalendarGet = '/settings_calendar_get';
            static const String settingsCalendarUpdate = '/settings_calendar_update';
            static const String seriesRebuild = '/series_rebuild';
            static const String seriesReassign = '/series_reassign';
            static const String exportsQuickXlsx = '/exports_quickXlsx';
            static const String exportsFirmRange = '/exports_firmRangeWithHistoryXlsx';
            static const String exportsTemplate = '/exports_myClientsTemplateXlsx';
          }
          EOF

          cat > lib/config/theme.dart << 'EOF'
          import 'package:flutter/material.dart';

          class AppTheme {
            // Windows 11 Colors
            static const Color primaryColor = Color(0xFF0078D4);
            static const Color primaryHover = Color(0xFF006CC1);
            static const Color backgroundColor = Color(0xFFF3F3F3);
            static const Color cardColor = Color(0xFFFFFFFF);
            static const Color textMain = Color(0xFF1B1B1B);
            static const Color textMuted = Color(0xFF5D5D5D);
            static const Color danger = Color(0xFFEF4444);
            static const Color warning = Color(0xFFF59E0B);
            static const Color success = Color(0xFF16A34A);

            static const LinearGradient primaryGradient = LinearGradient(
              colors: [Color(0xFF0078D4), Color(0xFF5AA7FF), Color(0xFF64D2FF)],
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
            );

            static ThemeData lightTheme = ThemeData(
              useMaterial3: true,
              colorScheme: ColorScheme.fromSeed(
                seedColor: primaryColor,
                brightness: Brightness.light,
              ),
              scaffoldBackgroundColor: backgroundColor,
              appBarTheme: const AppBarTheme(
                backgroundColor: Colors.transparent,
                elevation: 0,
                centerTitle: false,
              ),
              cardTheme: CardTheme(
                elevation: 0,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(16),
                ),
              ),
              inputDecorationTheme: InputDecorationTheme(
                filled: true,
                fillColor: Colors.white,
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: BorderSide(color: Colors.grey.shade200),
                ),
                enabledBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: BorderSide(color: Colors.grey.shade200),
                ),
                focusedBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: const BorderSide(color: primaryColor, width: 2),
                ),
              ),
              elevatedButtonTheme: ElevatedButtonThemeData(
                style: ElevatedButton.styleFrom(
                  backgroundColor: primaryColor,
                  foregroundColor: Colors.white,
                  elevation: 0,
                  padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 14),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                ),
              ),
            );

            static ThemeData darkTheme = ThemeData(
              useMaterial3: true,
              colorScheme: ColorScheme.fromSeed(
                seedColor: primaryColor,
                brightness: Brightness.dark,
              ),
              scaffoldBackgroundColor: const Color(0xFF0F0F10),
              cardTheme: CardTheme(
                elevation: 0,
                color: const Color(0xFF1A1A1C),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(16),
                ),
              ),
            );
          }
          EOF

          cat > lib/config/routes.dart << 'EOF'
          import 'package:flutter/material.dart';

          class AppRoutes {
            static const String splash = '/';
            static const String login = '/login';
            static const String home = '/home';
            static const String dashboard = '/dashboard';
            static const String tasks = '/tasks';
            static const String taskDetail = '/task-detail';
            static const String createTask = '/create-task';
            static const String calendar = '/calendar';
            static const String clients = '/clients';
            static const String clientDetail = '/client-detail';
            static const String createClient = '/create-client';
            static const String draftingStudio = '/drafting-studio';
            static const String team = '/team';
            static const String settings = '/settings';
            static const String auditLogs = '/audit-logs';
          }
          EOF

          # Main.dart placeholder
          cat > lib/main.dart << 'EOF'
          import 'package:flutter/material.dart';
          import 'package:flutter_riverpod/flutter_riverpod.dart';
          import 'package:firebase_core/firebase_core.dart';
          import 'firebase_options.dart';
          import 'config/theme.dart';
          import 'screens/splash_screen.dart';

          void main() async {
            WidgetsFlutterBinding.ensureInitialized();
            
            await Firebase.initializeApp(
              options: DefaultFirebaseOptions.currentPlatform,
            );
            
            runApp(
              const ProviderScope(
                child: ComplianceApp(),
              ),
            );
          }

          class ComplianceApp extends StatelessWidget {
            const ComplianceApp({super.key});

            @override
            Widget build(BuildContext context) {
              return MaterialApp(
                title: 'Compliance Management',
                debugShowCheckedModeBanner: false,
                theme: AppTheme.lightTheme,
                darkTheme: AppTheme.darkTheme,
                themeMode: ThemeMode.system,
                home: const SplashScreen(),
              );
            }
          }
          EOF

          # Splash screen placeholder
          cat > lib/screens/splash_screen.dart << 'EOF'
          import 'package:flutter/material.dart';
          import '../config/theme.dart';

          class SplashScreen extends StatefulWidget {
            const SplashScreen({super.key});

            @override
            State<SplashScreen> createState() => _SplashScreenState();
          }

          class _SplashScreenState extends State<SplashScreen> {
            @override
            void initState() {
              super.initState();
              // TODO: Check auth state and navigate
            }

            @override
            Widget build(BuildContext context) {
              return Scaffold(
                body: Container(
                  decoration: const BoxDecoration(
                    gradient: AppTheme.primaryGradient,
                  ),
                  child: const Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(
                          Icons.task_alt,
                          size: 80,
                          color: Colors.white,
                        ),
                        SizedBox(height: 24),
                        Text(
                          'Compliance Management',
                          style: TextStyle(
                            color: Colors.white,
                            fontSize: 24,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        SizedBox(height: 8),
                        Text(
                          'Tasks â€¢ Calendar â€¢ Mail Automation',
                          style: TextStyle(
                            color: Colors.white70,
                            fontSize: 14,
                          ),
                        ),
                        SizedBox(height: 48),
                        CircularProgressIndicator(
                          color: Colors.white,
                        ),
                      ],
                    ),
                  ),
                
