# .github/workflows/setup.yml
# PURPOSE: First-time setup - creates Flutter project and commits to repo
# RUN: Manually trigger from Actions tab (only run ONCE)

name: üöÄ First-Time Setup - Create Flutter Project

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Flutter project name (lowercase, underscores)'
        required: true
        default: 'compliance_app'
      org_name:
        description: 'Organization identifier (com.yourcompany)'
        required: true
        default: 'com.compliancemanagement'

env:
  FLUTTER_VERSION: '3.19.0'
  JAVA_VERSION: '17'

jobs:
  setup:
    name: Create Flutter Project
    runs-on: ubuntu-latest
    
    steps:
      # ========== CHECKOUT EMPTY REPO ==========
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # ========== SETUP JAVA (NO CACHE - REPO IS EMPTY) ==========
      - name: ‚òï Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          # NOTE: No cache here - gradle files don't exist yet!

      # ========== SETUP FLUTTER WITH CACHE ==========
      - name: üê¶ Setup Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          cache-key: 'flutter-:os:-:channel:-:version:-:arch:-:hash:'
          cache-path: '${{ runner.tool_cache }}/flutter/:channel:-:version:-:arch:'

      # ========== VERIFY FLUTTER ==========
      - name: ‚úÖ Verify Flutter Installation
        run: |
          flutter --version
          flutter doctor -v

      # ========== CREATE FLUTTER PROJECT ==========
      - name: üèóÔ∏è Create Flutter Project
        run: |
          # Create project with all platforms
          flutter create \
            --project-name=${{ github.event.inputs.project_name }} \
            --org=${{ github.event.inputs.org_name }} \
            --platforms=android,ios,web \
            --description="Compliance Management System - Tasks, Calendar, Mail Automation" \
            temp_project
          
          # Move contents to repo root (excluding .git)
          shopt -s dotglob
          mv temp_project/* .
          rm -rf temp_project
          
          echo "‚úÖ Flutter project created successfully!"

      # ========== ADD DEPENDENCIES TO PUBSPEC.YAML ==========
      - name: üì¶ Update pubspec.yaml with Dependencies
        run: |
          cat > pubspec.yaml << 'EOF'
          name: ${{ github.event.inputs.project_name }}
          description: Compliance Management System - Tasks, Calendar, Mail Automation
          publish_to: 'none'
          version: 1.0.0+1

          environment:
            sdk: '>=3.2.0 <4.0.0'

          dependencies:
            flutter:
              sdk: flutter
            
            # Firebase
            firebase_core: ^2.25.0
            firebase_auth: ^4.17.0
            cloud_firestore: ^4.15.0
            firebase_messaging: ^14.7.0
            firebase_storage: ^11.6.0
            
            # State Management
            flutter_riverpod: ^2.4.10
            
            # HTTP & API
            dio: ^5.4.1
            
            # UI Components
            flutter_svg: ^2.0.10
            cached_network_image: ^3.3.1
            shimmer: ^3.0.0
            google_fonts: ^6.1.0
            
            # Calendar
            table_calendar: ^3.0.9
            
            # Charts
            fl_chart: ^0.66.2
            
            # File Handling
            file_picker: ^6.1.1
            open_file: ^3.3.2
            path_provider: ^2.1.2
            
            # Local Storage
            shared_preferences: ^2.2.2
            
            # Utils
            intl: ^0.18.1
            url_launcher: ^6.2.4
            package_info_plus: ^5.0.1
            connectivity_plus: ^5.0.2
            
            # Biometric Auth
            local_auth: ^2.1.8
            
            # Icons
            cupertino_icons: ^1.0.6

          dev_dependencies:
            flutter_test:
              sdk: flutter
            flutter_lints: ^3.0.1
            flutter_launcher_icons: ^0.13.1
            build_runner: ^2.4.8

          # App Icon Configuration
          flutter_launcher_icons:
            android: true
            ios: true
            web:
              generate: true
            image_path: "assets/icon/app_icon.png"
            adaptive_icon_background: "#0078D4"
            adaptive_icon_foreground: "assets/icon/app_icon_foreground.png"

          flutter:
            uses-material-design: true
            
            assets:
              - assets/images/
              - assets/icon/

          EOF

      # ========== CREATE FOLDER STRUCTURE ==========
      - name: üìÅ Create Project Structure
        run: |
          # Create directories
          mkdir -p lib/config
          mkdir -p lib/models
          mkdir -p lib/services
          mkdir -p lib/providers
          mkdir -p lib/screens
          mkdir -p lib/widgets
          mkdir -p lib/utils
          mkdir -p assets/images
          mkdir -p assets/icon
          
          echo "‚úÖ Folder structure created!"

      # ========== CREATE CONFIG FILES ==========
      - name: üìù Create Config Files
        run: |
          # API Config
          cat > lib/config/api_config.dart << 'EOF'
          // API Configuration
          // TODO: Replace with your Netlify URL
          class ApiConfig {
            static const String baseUrl = 'https://YOUR-SITE.netlify.app/.netlify/functions';
            
            // Endpoints
            static const String tasksCreateOne = '/tasks_createone';
            static const String tasksUpdateStatus = '/tasks_updatestatus';
            static const String tasksUpdateTask = '/tasks_updatetask';
            static const String tasksDelete = '/tasks_delete';
            static const String tasksBulkImport = '/tasks_bulkimportxlsx';
            static const String clientsCreate = '/clients_create';
            static const String usersSetRole = '/users_setrole';
            static const String usersSetManager = '/users_setmanager';
            static const String usersList = '/users_list';
            static const String settingsGet = '/settings_get';
            static const String settingsUpdate = '/settings_update';
            static const String settingsCalendarGet = '/settings_calendar_get';
            static const String settingsCalendarUpdate = '/settings_calendar_update';
            static const String seriesRebuild = '/series_rebuild';
            static const String seriesReassign = '/series_reassign';
            static const String exportsQuickXlsx = '/exports_quickXlsx';
            static const String exportsFirmRange = '/exports_firmRangeWithHistoryXlsx';
            static const String exportsTemplate = '/exports_myClientsTemplateXlsx';
          }
          EOF

          # Theme
          cat > lib/config/theme.dart << 'EOF'
          import 'package:flutter/material.dart';

          class AppTheme {
            // Windows 11 Colors
            static const Color primaryColor = Color(0xFF0078D4);
            static const Color primaryHover = Color(0xFF006CC1);
            static const Color backgroundColor = Color(0xFFF3F3F3);
            static const Color cardColor = Color(0xFFFFFFFF);
            static const Color textMain = Color(0xFF1B1B1B);
            static const Color textMuted = Color(0xFF5D5D5D);
            static const Color danger = Color(0xFFEF4444);
            static const Color warning = Color(0xFFF59E0B);
            static const Color success = Color(0xFF16A34A);

            static const LinearGradient primaryGradient = LinearGradient(
              colors: [Color(0xFF0078D4), Color(0xFF5AA7FF), Color(0xFF64D2FF)],
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
            );

            static ThemeData lightTheme = ThemeData(
              useMaterial3: true,
              colorScheme: ColorScheme.fromSeed(
                seedColor: primaryColor,
                brightness: Brightness.light,
              ),
              scaffoldBackgroundColor: backgroundColor,
              appBarTheme: const AppBarTheme(
                backgroundColor: Colors.transparent,
                elevation: 0,
                centerTitle: false,
              ),
              cardTheme: CardTheme(
                elevation: 0,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(16),
                ),
              ),
              inputDecorationTheme: InputDecorationTheme(
                filled: true,
                fillColor: Colors.white,
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: BorderSide(color: Colors.grey.shade200),
                ),
                enabledBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: BorderSide(color: Colors.grey.shade200),
                ),
                focusedBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: const BorderSide(color: primaryColor, width: 2),
                ),
              ),
              elevatedButtonTheme: ElevatedButtonThemeData(
                style: ElevatedButton.styleFrom(
                  backgroundColor: primaryColor,
                  foregroundColor: Colors.white,
                  elevation: 0,
                  padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 14),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                ),
              ),
            );

            static ThemeData darkTheme = ThemeData(
              useMaterial3: true,
              colorScheme: ColorScheme.fromSeed(
                seedColor: primaryColor,
                brightness: Brightness.dark,
              ),
              scaffoldBackgroundColor: const Color(0xFF0F0F10),
              cardTheme: CardTheme(
                elevation: 0,
                color: const Color(0xFF1A1A1C),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(16),
                ),
              ),
            );
          }
          EOF

          # Routes
          cat > lib/config/routes.dart << 'EOF'
          class AppRoutes {
            static const String splash = '/';
            static const String login = '/login';
            static const String home = '/home';
            static const String dashboard = '/dashboard';
            static const String tasks = '/tasks';
            static const String taskDetail = '/task-detail';
            static const String createTask = '/create-task';
            static const String calendar = '/calendar';
            static const String clients = '/clients';
            static const String clientDetail = '/client-detail';
            static const String createClient = '/create-client';
            static const String draftingStudio = '/drafting-studio';
            static const String team = '/team';
            static const String settings = '/settings';
            static const String auditLogs = '/audit-logs';
          }
          EOF

      # ========== CREATE MAIN FILES ==========
      - name: üìù Create Main Files
        run: |
          # Main.dart
          cat > lib/main.dart << 'EOF'
          import 'package:flutter/material.dart';
          import 'package:flutter_riverpod/flutter_riverpod.dart';
          import 'package:firebase_core/firebase_core.dart';
          import 'firebase_options.dart';
          import 'config/theme.dart';
          import 'screens/splash_screen.dart';

          void main() async {
            WidgetsFlutterBinding.ensureInitialized();
            
            await Firebase.initializeApp(
              options: DefaultFirebaseOptions.currentPlatform,
            );
            
            runApp(
              const ProviderScope(
                child: ComplianceApp(),
              ),
            );
          }

          class ComplianceApp extends StatelessWidget {
            const ComplianceApp({super.key});

            @override
            Widget build(BuildContext context) {
              return MaterialApp(
                title: 'Compliance Management',
                debugShowCheckedModeBanner: false,
                theme: AppTheme.lightTheme,
                darkTheme: AppTheme.darkTheme,
                themeMode: ThemeMode.system,
                home: const SplashScreen(),
              );
            }
          }
          EOF

          # Splash Screen
          cat > lib/screens/splash_screen.dart << 'EOF'
          import 'package:flutter/material.dart';
          import '../config/theme.dart';

          class SplashScreen extends StatefulWidget {
            const SplashScreen({super.key});

            @override
            State<SplashScreen> createState() => _SplashScreenState();
          }

          class _SplashScreenState extends State<SplashScreen> {
            @override
            void initState() {
              super.initState();
              // TODO: Check auth state and navigate
            }

            @override
            Widget build(BuildContext context) {
              return Scaffold(
                body: Container(
                  decoration: const BoxDecoration(
                    gradient: AppTheme.primaryGradient,
                  ),
                  child: const Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(
                          Icons.task_alt,
                          size: 80,
                          color: Colors.white,
                        ),
                        SizedBox(height: 24),
                        Text(
                          'Compliance Management',
                          style: TextStyle(
                            color: Colors.white,
                            fontSize: 24,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        SizedBox(height: 8),
                        Text(
                          'Tasks ‚Ä¢ Calendar ‚Ä¢ Mail Automation',
                          style: TextStyle(
                            color: Colors.white70,
                            fontSize: 14,
                          ),
                        ),
                        SizedBox(height: 48),
                        CircularProgressIndicator(
                          color: Colors.white,
                        ),
                      ],
                    ),
                  ),
                ),
              );
            }
          }
          EOF

          # Firebase Options (placeholder)
          cat > lib/firebase_options.dart << 'EOF'
          // TODO: Run 'flutterfire configure' locally to regenerate this file
          // This is a placeholder with your existing Firebase config
          
          import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
          import 'package:flutter/foundation.dart'
              show defaultTargetPlatform, kIsWeb, TargetPlatform;

          class DefaultFirebaseOptions {
            static FirebaseOptions get currentPlatform {
              if (kIsWeb) {
                return web;
              }
              switch (defaultTargetPlatform) {
                case TargetPlatform.android:
                  return android;
                case TargetPlatform.iOS:
                  return ios;
                default:
                  throw UnsupportedError('Unsupported platform');
              }
            }

            static const FirebaseOptions web = FirebaseOptions(
              apiKey: 'AIzaSyCnWS-V96J6YDBVYKOeL5p8aa45GPTdSEg',
              appId: '1:4348274796:web:a9e1720c2ae223035bd049',
              messagingSenderId: '4348274796',
              projectId: 'compliance-management-484405',
              authDomain: 'compliance-management-484405.firebaseapp.com',
              storageBucket: 'compliance-management-484405.firebasestorage.app',
            );

            static const FirebaseOptions android = FirebaseOptions(
              apiKey: 'AIzaSyCnWS-V96J6YDBVYKOeL5p8aa45GPTdSEg',
              appId: '1:4348274796:android:YOUR_ANDROID_APP_ID',
              messagingSenderId: '4348274796',
              projectId: 'compliance-management-484405',
              storageBucket: 'compliance-management-484405.firebasestorage.app',
            );

            static const FirebaseOptions ios = FirebaseOptions(
              apiKey: 'AIzaSyCnWS-V96J6YDBVYKOeL5p8aa45GPTdSEg',
              appId: '1:4348274796:ios:YOUR_IOS_APP_ID',
              messagingSenderId: '4348274796',
              projectId: 'compliance-management-484405',
              storageBucket: 'compliance-management-484405.firebasestorage.app',
              iosBundleId: 'com.compliancemanagement.complianceApp',
            );
          }
          EOF

      # ========== CREATE UTILS ==========
      - name: üìù Create Utils
        run: |
          # Date Helpers
          cat > lib/utils/date_helpers.dart << 'EOF'
          import 'package:intl/intl.dart';

          class DateHelpers {
            static const String istTimeZone = 'Asia/Kolkata';
            
            /// Get today's date in YYYY-MM-DD format (IST)
            static String todayYmdIST() {
              final now = DateTime.now().toUtc().add(const Duration(hours: 5, minutes: 30));
              return DateFormat('yyyy-MM-dd').format(now);
            }
            
            /// Convert DD-MM-YYYY to YYYY-MM-DD
            static String dmyToYmd(String dmy) {
              final parts = dmy.split('-');
              if (parts.length != 3) throw FormatException('Invalid date: $dmy');
              return '${parts[2]}-${parts[1]}-${parts[0]}';
            }
            
            /// Convert YYYY-MM-DD to DD-MM-YYYY
            static String ymdToDmy(String ymd) {
              final parts = ymd.split('-');
              if (parts.length != 3) return '';
              return '${parts[2]}-${parts[1]}-${parts[0]}';
            }
            
            /// Calculate days between two dates
            static int dateDiffDays(String fromYmd, String toYmd) {
              final from = DateTime.parse(fromYmd);
              final to = DateTime.parse(toYmd);
              return to.difference(from).inDays;
            }
            
            /// Format date for display
            static String formatDisplay(String ymd) {
              try {
                final date = DateTime.parse(ymd);
                return DateFormat('d MMM yyyy').format(date);
              } catch (_) {
                return ymd;
              }
            }
          }
          EOF

          # Constants
          cat > lib/utils/constants.dart << 'EOF'
          class AppConstants {
            // Task Statuses
            static const List<String> taskStatuses = [
              'PENDING',
              'IN_PROGRESS',
              'CLIENT_PENDING',
              'APPROVAL_PENDING',
              'COMPLETED',
            ];
            
            // Categories
            static const List<String> categories = [
              'GST',
              'TDS',
              'INCOME_TAX',
              'ROC',
              'ACCOUNTING',
              'AUDIT',
              'OTHER',
            ];
            
            // Recurrence
            static const List<String> recurrenceTypes = [
              'AD_HOC',
              'DAILY',
              'WEEKLY',
              'BIWEEKLY',
              'MONTHLY',
              'BIMONTHLY',
              'QUARTERLY',
              'HALF_YEARLY',
              'YEARLY',
            ];
            
            // Roles
            static const List<String> userRoles = [
              'PARTNER',
              'MANAGER',
              'WORKER',
            ];
          }
          EOF

      # ========== CREATE PLACEHOLDER ASSETS ==========
      - name: üìÅ Create Placeholder Assets
        run: |
          # Create placeholder files so assets folder is not empty
          echo "Add app_icon.png (1024x1024) here" > assets/icon/README.txt
          echo "Add images here" > assets/images/README.txt

      # ========== CREATE README ==========
      - name: üìñ Create README
        run: |
          cat > README.md << 'EOF'
          # Compliance Management App

          Flutter app for Compliance Management System.

          ## Platforms
          - ‚úÖ Android
          - ‚úÖ iOS
          - ‚úÖ Web

          ## Setup

          ### 1. Clone and Setup Firebase
          ```bash
          # Clone repo
          git clone <your-repo-url>
          cd compliance_app

          # Install FlutterFire CLI (one-time)
          dart pub global activate flutterfire_cli

          # Configure Firebase (run locally)
          flutterfire configure --project=compliance-management-484405
          ```

          ### 2. Update API URL
          Edit `lib/config/api_config.dart` and replace with your Netlify URL.

          ### 3. Add App Icon
          Add `app_icon.png` (1024x1024) to `assets/icon/`

          ## Build

          ### Android APK
          Trigger "üì± Build Android APK" workflow in GitHub Actions

          ### Web
          Trigger "üåê Build Web" workflow in GitHub Actions

          ### Deploy
          Trigger "üöÄ Deploy to Firebase Hosting" workflow

          ## Architecture

          ```
          lib/
          ‚îú‚îÄ‚îÄ config/      # API, Theme, Routes
          ‚îú‚îÄ‚îÄ models/      # Data models
          ‚îú‚îÄ‚îÄ services/    # API, Auth, Firestore
          ‚îú‚îÄ‚îÄ providers/   # State management (Riverpod)
          ‚îú‚îÄ‚îÄ screens/     # UI screens
          ‚îú‚îÄ‚îÄ widgets/     # Reusable widgets
          ‚îî‚îÄ‚îÄ utils/       # Helpers, constants
          ```

          ## Firebase Project
          Project ID: `compliance-management-484405`
          EOF

      # ========== UPDATE GITIGNORE ==========
      - name: üôà Update .gitignore
        run: |
          cat >> .gitignore << 'EOF'

          # Additional ignores
          *.jks
          *.keystore
          key.properties

          # Build outputs
          *.apk
          *.aab
          *.ipa

          # Local env
          .env
          .env.*
          EOF

      # ========== GET DEPENDENCIES ==========
      - name: üì¶ Get Dependencies
        run: flutter pub get

      # ========== COMMIT AND PUSH ==========
      - name: üíæ Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git commit -m "üöÄ Initial Flutter project setup

          - Created Flutter project with Android, iOS, Web support
          - Added Firebase and state management dependencies
          - Created folder structure (config, models, services, screens, etc.)
          - Added placeholder files and configuration
          - Ready for development!
          
          Next steps:
          1. Run 'flutterfire configure' locally
          2. Update lib/config/api_config.dart with Netlify URL
          3. Add app icon to assets/icon/"
          git push

      # ========== SUMMARY ==========
      - name: üìã Summary
        run: |
          echo "========================================="
          echo "‚úÖ SETUP COMPLETE!"
          echo "========================================="
          echo ""
          echo "Your Flutter project is ready!"
          echo ""
          echo "Next steps:"
          echo "1. Clone repo locally: git clone <your-repo-url>"
          echo "2. Run: cd ${{ github.event.inputs.project_name }}"
          echo "3. Run: flutterfire configure --project=compliance-management-484405"
          echo "4. Update lib/config/api_config.dart with your Netlify URL"
          echo "5. Add app icon to assets/icon/app_icon.png"
          echo ""
          echo "To build APK: Run 'üì± Build Android APK' workflow"
          echo "To build Web: Run 'üåê Build Web' workflow"
          echo "To deploy:    Run 'üöÄ Deploy to Firebase Hosting' workflow"
          echo "========================================="
